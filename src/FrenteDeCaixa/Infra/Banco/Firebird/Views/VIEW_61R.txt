CREATE OR ALTER VIEW VIEW_61R
(
 GTIN,
 DATA_EMISSAO,
 MES_EMISSAO,
 ANO_EMISSAO,
 ECF_ICMS_ST,
 SOMA_QUANTIDADE,
 SOMA_ITEM,
 SOMA_BASE_ICMS 
) AS 

select p.GTIN,
       NFc.DATA_EMISSAO,
       EXTRACT(MONTH from(NFc.DATA_EMISSAO)) AS MES_EMISSAO,
       EXTRACT(YEAR from(NFc.DATA_EMISSAO))  AS ANO_EMISSAO,
       p.ECF_ICMS_ST,
       COALESCE(sum(NFd.QUANTIDADE),0) AS SOMA_QUANTIDADE,
       COALESCE(sum(NFd.VALOR_TOTAL),0) AS SOMA_ITEM,
       COALESCE(sum(NFd.BASE_ICMS),0) AS SOMA_BASE_ICMS
from NOTA_FISCAL_CABECALHO NFc
LEFT JOIN NOTA_FISCAL_DETALHE NFd ON (NFd.ID_NF_CABECALHO = NFc.ID)
LEFT JOIN produto p ON (NFd.ID_PRODUTO = p.ID)
GROUP BY EXTRACT(MONTH from(NFc.DATA_EMISSAO)),EXTRACT(YEAR from(NFc.DATA_EMISSAO)),p.GTIN,p.ECF_ICMS_ST,NFc.DATA_EMISSAO

;

